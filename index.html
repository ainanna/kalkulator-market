<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4fc3f7">
<title>Daily Task</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
.task.dragging {
 opacity: 0.4;
}
.task.drag-over {
 outline: 2px dashed var(--accent);
}  
.update-popup {
 position: fixed;
 inset: 0;
 background: rgba(0,0,0,.55);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 9999;
}

.update-popup.hidden { display: none; }

.update-card {
 background: #0b1220;
 color: #fff;
 padding: 1.4rem;
 border-radius: 14px;
 width: min(320px, 90%);
 box-shadow: 0 10px 40px rgba(0,0,0,.4);
}

.update-card h3 {
 margin: 0 0 .4rem;
 font-size: 1.1rem;
}

.update-card p {
 font-size: .9rem;
 opacity: .85;
}

.update-actions {
 display: flex;
 gap: .5rem;
 margin-top: 1rem;
}

.update-actions button {
 flex: 1;
 padding: .55rem;
 border-radius: 10px;
 border: none;
 font-weight: 600;
 cursor: pointer;
}

.update-actions button:first-child {
 background: #4f8cff;
 color: #fff;
}

.update-actions .ghost {
 background: transparent;
 color: #ccc;
 border: 1px solid #333;
}
/* ===== MODAL RESET SETTINGS ===== */
.modal-backdrop{
 position:fixed;inset:0;
 background:rgba(0,0,0,.6);
 display:flex;align-items:center;justify-content:center;
 z-index:99;
}
.modal{
 width:min(420px,95%);
 background:var(--card);
 border-radius:16px;
 padding:14px;
}
.modal h3{
 margin:0 0 10px;
 font-size:14px;
 letter-spacing:.5px;
}
.modal h4{
 margin:8px 0 4px;
 font-size:11px;
 letter-spacing:1px;
}
.form-row{
 display:flex;
 gap:8px;
 margin-bottom:8px;
}
.form-row label{
 flex:1;
 font-size:11px;
 opacity:.8;
}
.modal-footer{
 display:flex;
 justify-content:flex-end;
 gap:8px;
 margin-top:10px;
}  
:root{
 --bg:#0b1220;--card:#121b2f;
 --daily:#1a2a4a;--weekly:#1a1538;--shop:#2a1a1a;
 --accent:#4fc3f7;--weeklyAccent:#b388ff;--shopAccent:#ffb74d;
 --danger:#ff5252;--ok:#00e676;--text:#e0e6ff;
}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}

header{
 padding:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center
}
select,button{
 background:var(--card);color:var(--text);
 border:1px solid #243056;padding:6px 10px;border-radius:6px
}
button{cursor:pointer}
button.primary{background:var(--accent);color:#000}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fill,minmax(330px,1fr));
 gap:14px;padding:14px
}
.card{background:var(--card);border-radius:14px;padding:12px}

.char-header{
 display:flex;justify-content:space-between;align-items:center
}

.section{margin-top:10px;border-radius:10px;padding:8px}
.section.daily{background:var(--daily)}
.section.weekly{background:var(--weekly)}
.section.shop{background:var(--shop)}

.section-header{
 display:flex;justify-content:space-between;align-items:center
}
.section h4{
 margin:4px 0 6px;font-size:12px;letter-spacing:1px;opacity:.85
}
.section.daily h4{color:var(--accent)}
.section.weekly h4{color:var(--weeklyAccent)}
.section.shop h4{color:var(--shopAccent)}

.task{
 display:flex;align-items:center;
 padding:6px 8px;border-radius:6px;margin:4px 0;
 background:rgba(255,255,255,.03);
}
.task.reset-soon{
 background:rgba(255,82,82,.18);
 border:1px solid var(--danger);
}
.task.reset-now{
 background:rgba(79,195,247,.14);
 border:1px solid var(--accent);
}

.task label{
 display:flex;align-items:center;gap:6px;
 cursor:pointer;flex:1
}

.countdown{font-size:11px;opacity:.8}

.progress-wrap{margin-top:8px}
.progress-label{font-size:11px;opacity:.8;margin-bottom:4px}
.progress{
 height:6px;background:#1c2748;border-radius:4px;overflow:hidden
}
.progress span{
 display:block;height:100%;
 background:linear-gradient(90deg,var(--ok),var(--accent));
}
.calc-modes label{
 display:block;
 font-size:12px;
 margin:6px 0;
 cursor:pointer;
}

.calc-input input{
 width:100%;
 padding:10px;
 background:#0b1220;
 border:1px solid #243056;
 border-radius:8px;
 color:var(--text);
 font-size:15px;
}

.calc-result{
 margin-top:10px;
 font-size:12px;
}

.calc-result div{
 display:flex;
 justify-content:space-between;
 padding:6px 0;
 border-bottom:1px dashed #243056;
}

.calc-keypad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:6px;
 margin-top:10px;
}

.calc-keypad button,
.calc-keypad select{
 background:#1c2748;
 border:1px solid #243056;
 color:var(--text);
 padding:10px;
 border-radius:8px;
 font-weight:600;
 cursor:pointer;
}

.calc-clear{
 grid-column:span;
 background:rgba(255,82,82,.25);
 border-color:var(--danger);
 color:var(--danger);
}
.calc-keypad button[data-back]{
 grid-column: span;
 background:#243056;
}
</style>
</head>

<body>

<header>
 <b>Daily Task</b>
 <select id="accountSelect"></select>
 <button onclick="addAccount()">+ Account</button>
 <button onclick="addCharacter()" class="primary">+ Character</button>
 <button onclick="openMarketCalc()">ðŸ“Š Market Calc</button>
 <button onclick="openResetSettings()">âš™ Reset Settings</button>
 <button onclick="resetAllData()" 
 style="border:1px solid #ff5252;color:#ff5252">
 Reset Data
</button>
<button onclick="forceUpdatePWA()"
 style="border:1px solid #ff9800;color:#ff9800">
 ðŸ”„ Force Update
</button>
</header>

<div id="app" class="grid"></div>

<script>
/* ================= DATA ================= */
const STORE="aion2_tracker_v722";
const RESET_HIGHLIGHT_MS=10*60*1000;

let data=JSON.parse(localStorage.getItem(STORE))||{
 accounts:[],activeAccountId:null,
tasks:[
 {id:"t1",name:"Nightmare",type:"daily",hour:4,minute:0},
 {id:"t2",name:"Daily Dungeon",type:"daily",hour:4,minute:0},
 {id:"t3",name:"Duty",type:"daily",hour:4,minute:0},
 {id:"t3a",name:"Shugo Festival",type:"daily",hour:4,minute:0,max:2},
 {id:"t4",name:"Raid",type:"weekly",day:3,hour:4,minute:0},
 {id:"t5",name:"Ascension Trial",type:"weekly",day:3,hour:4,minute:0},
 {id:"t6",name:"Weekly Scroll",type:"weekly",day:3,hour:4,minute:0},
 {id:"t7",name:"Abyss Scroll",type:"weekly",day:3,hour:4,minute:0},
{id:"t8",name:"Arcanist",type:"weekly",day:3,hour:4,minute:0,max:5},
{id:"t9",name:"Deus",type:"weekly",day:3,hour:4,minute:0,max:5},
 {id:"t10",name:"Odyle Craft",type:"weekly",day:3,hour:4,minute:0},

 {id:"t11",name:"Odyle Shop",type:"shop",day:0,hour:23,minute:0}
]
};

const save=()=>localStorage.setItem(STORE,JSON.stringify(data));
const now=()=>new Date();
const active=()=>data.accounts.find(a=>a.id===data.activeAccountId);

/* ================= RESET ENGINE ================= */
function resetWindowId(t){
 const d = now();
 const r = new Date(d);

 // DAILY
 if(t.type === "daily"){
  r.setHours(t.hour, t.minute || 0, 0, 0);
  if(d < r) r.setDate(r.getDate() - 1);
  return r.toDateString();
 }

 // WEEKLY & SHOP
 if(t.type === "weekly" || t.type === "shop"){
  const diff = (d.getDay() - t.day + 7) % 7;
  r.setDate(d.getDate() - diff);
  r.setHours(t.hour, t.minute || 0, 0, 0);
  if(d < r) r.setDate(r.getDate() - 7);
  return r.toDateString();
 }
}

function nextReset(t){
 const d=now(),r=new Date(d);
 if(t.type==="daily"){
  r.setHours(t.hour, t.minute || 0, 0, 0);
  if(d>=r) r.setDate(r.getDate()+1);
  return r;
 }
 const diff=(t.day-d.getDay()+7)%7;
 r.setDate(d.getDate()+diff);
 r.setHours(t.hour, t.minute || 0, 0, 0);
 if(d>=r) r.setDate(r.getDate()+7);
 return r;
}
function autoResetCheck(){
 let changed=false;

 data.accounts.forEach(acc=>{
  acc.characters.forEach(c=>{
   data.tasks.forEach(t=>{
    const win = resetWindowId(t);
    const p = c.progress[t.id];
    if(!p) return;

    if(p.lastReset !== win){
c.progress[t.id]={
 checked:false,
 count: t.max ? 0 : undefined,
 lastReset:win,
 resetAt:Date.now()
};
     changed=true;
    }
   });
  });
 });

 if(changed){
  save();
  render();
 }
}

/* ================= TIME FORMAT ================= */
function formatHMS(ms){
 if(ms<=0) return "RESET";
 const s=Math.floor(ms/1000);
 const d=Math.floor(s/86400);
 const h=Math.floor((s%86400)/3600);
 const m=Math.floor((s%3600)/60);
 const sec=s%60;
 if(d>0) return `${d}d ${h}h ${m}m`;
 return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

function sectionCountdown(type){
 let soonest=null;
 data.tasks.filter(t=>t.type===type).forEach(t=>{
  const r=nextReset(t);
  if(!soonest||r<soonest) soonest=r;
 });
 return soonest?formatHMS(soonest-now()):"";
}

/* ================= RENDER ================= */
const accountSelect = document.getElementById("accountSelect");
const app = document.getElementById("app");
function render(){
data.tasks.forEach(t => t.minute ??= 0);
 accountSelect.innerHTML="";
 data.accounts.forEach(a=>accountSelect.append(new Option(a.name,a.id)));
 accountSelect.value=data.activeAccountId;
 accountSelect.onchange=e=>{
  data.activeAccountId=e.target.value;save();render();
 };

 app.innerHTML="";
 const acc=active(); if(!acc)return;

 acc.characters.forEach(c=>{
  let dDone=0,dTotal=0,wDone=0,wTotal=0,sDone=0,sTotal=0;

  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
   <div class="char-header">
    <b>${c.name}</b>
    <button onclick="deleteCharacter('${c.id}')" style="
     background:transparent;
     border:1px solid #ff5252;
     color:#ff5252;
     border-radius:6px;
     padding:2px 6px;
     cursor:pointer
    ">ðŸ—‘</button>
   </div>
  `;

  const daily=document.createElement("div");
  daily.className="section daily";
  daily.innerHTML=`<div class="section-header"><h4>DAILY</h4><span class="countdown" data-type="daily">${sectionCountdown("daily")}</span></div>`;

  const weekly=document.createElement("div");
  weekly.className="section weekly";
  weekly.innerHTML=`<div class="section-header"><h4>WEEKLY</h4><span class="countdown" data-type="weekly">${sectionCountdown("weekly")}</span></div>`;

  const shop=document.createElement("div");
  shop.className="section shop";
  shop.innerHTML=`<div class="section-header"><h4>WEEKLY SHOP</h4><span class="countdown" data-type="shop"
>${sectionCountdown("shop")}</span></div>`;

data.tasks.forEach(t=>{
 c.progress[t.id] ??= {
  checked:false,
  count: t.max ? 0 : undefined,
  lastReset: resetWindowId(t),
  resetAt: 0
};

// ðŸ”¥ MIGRATION SAFE
if(t.max && c.progress[t.id].count == null){
 c.progress[t.id].count = c.progress[t.id].checked ? t.max : 0;
}

   let sec;
if(t.type === "daily"){
 sec = daily;
 dTotal++;
 if(c.progress[t.id].checked) dDone++;
}
else if(t.type === "weekly"){
 sec = weekly;
 wTotal++;
 if(c.progress[t.id].checked) wDone++;
}
else if(t.type === "shop"){
 sec = shop;
 sTotal++;
 if(c.progress[t.id].checked) sDone++;
}
else{
 return; // â›” skip task tidak dikenal
}

const row=document.createElement("div");
row.className="task";
row.draggable = true;
row.dataset.taskId = t.id;
row.addEventListener("dragstart", e => {
 row.classList.add("dragging");
 e.dataTransfer.setData("text/plain", t.id);
});

row.addEventListener("dragend", () => {
 row.classList.remove("dragging");
});

row.addEventListener("dragover", e => {
 e.preventDefault();
 row.classList.add("drag-over");
});

row.addEventListener("dragleave", () => {
 row.classList.remove("drag-over");
});

row.addEventListener("drop", e => {
 e.preventDefault();
 row.classList.remove("drag-over");

 const fromId = e.dataTransfer.getData("text/plain");
 const toId   = row.dataset.taskId;
 if (fromId === toId) return;

 reorderTask(fromId, toId);
});
   const label=document.createElement("label");
   const cb=document.createElement("input");
   cb.type="checkbox";
   cb.checked=c.progress[t.id].checked;
cb.onchange = () => {
 c.progress[t.id].checked = cb.checked;

 if (t.max) {
  c.progress[t.id].count = cb.checked ? t.max : 0;

  // update teks counter
  const span = row.querySelector("span");
  if (span) {
   span.textContent = `${c.progress[t.id].count}/${t.max}`;
  }
 }

 row.classList.remove("reset-now");

 save();
 updateProgress(card, c);
};
   label.append(cb,t.name);
   row.append(label);

   const diff=nextReset(t)-now();
   if(diff>0&&diff<3600000)row.classList.add("reset-soon");
   if(Date.now()-c.progress[t.id].resetAt<RESET_HIGHLIGHT_MS&&!c.progress[t.id].checked)
    row.classList.add("reset-now");
if(t.max){
 const counter=document.createElement("div");
 counter.style.display="flex";
 counter.style.gap="6px";
 counter.style.alignItems="center";

 const minus=document.createElement("button");
 minus.textContent="âˆ’";

 const plus=document.createElement("button");
 plus.textContent="+";

 const text=document.createElement("span");
 text.textContent=`${c.progress[t.id].count}/${t.max}`;

 minus.onclick=()=>{
  c.progress[t.id].count=Math.max(0,c.progress[t.id].count-1);
  c.progress[t.id].checked=c.progress[t.id].count===t.max;
  save(); render();
 };

 plus.onclick=()=>{
  c.progress[t.id].count=Math.min(t.max,c.progress[t.id].count+1);
  c.progress[t.id].checked=c.progress[t.id].count===t.max;
  save(); render();
 };

 counter.append(minus,text,plus);
 row.append(counter);
}
   sec.append(row);
  });

card.append(
 daily,progressBar("daily",dDone,dTotal),
 weekly,progressBar("weekly",wDone,wTotal),
 shop,progressBar("shop",sDone,sTotal)
);

  app.append(card);
 });

}
function reorderTask(fromId, toId){
 const fromIndex = data.tasks.findIndex(t => t.id === fromId);
 const toIndex   = data.tasks.findIndex(t => t.id === toId);
 if(fromIndex < 0 || toIndex < 0) return;

 const [moved] = data.tasks.splice(fromIndex, 1);
 data.tasks.splice(toIndex, 0, moved);

 save();
 render();
}
function progressBar(type, done, total){
 const w = document.createElement("div");
 w.className = `progress-wrap progress-${type}`;
 w.innerHTML = `
  <div class="progress-label">${type.toUpperCase()}: ${done}/${total}</div>
  <div class="progress">
   <span style="width:${total ? done/total*100 : 0}%"></span>
  </div>
 `;
 return w;
}
function updateProgress(card, character){
 const sections = {
  daily:{done:0,total:0},
  weekly:{done:0,total:0},
  shop:{done:0,total:0}
 };

data.tasks.forEach(t=>{
 const p = character.progress[t.id];
 if(!p || !sections[t.type]) return;

 sections[t.type].total++;
 if(p.checked) sections[t.type].done++;
});

 Object.entries(sections).forEach(([type,v])=>{
  const wrap = card.querySelector(`.progress-${type}`);
  if(!wrap) return;

  wrap.querySelector(".progress-label").textContent =
   `${type.toUpperCase()}: ${v.done}/${v.total}`;

  wrap.querySelector(".progress span").style.width =
   v.total ? (v.done/v.total*100)+"%" : "0%";
 });
}
/* ================= ACCOUNT & CHARACTER ================= */
function addAccount(){
 const n = prompt("Nama Account");
 if(!n || !n.trim()) return;

 const id = "acc" + Date.now();

 data.accounts.push({
  id: id,
  name: n.trim(),
  characters: []
 });

 data.activeAccountId = id;
 save();
 render();
}

function addCharacter(){
 const a=active(); if(!a)return;
 const n=prompt("Nama Character");
 if(n){
  a.characters.push({id:"c"+Date.now(),name:n,progress:{}});
  save();render();
 }
}

function deleteCharacter(charId){
 const acc=active(); if(!acc)return;
 const char=acc.characters.find(c=>c.id===charId);
 if(!char) return;
 if(!confirm(`Hapus character "${char.name}"?`)) return;
 acc.characters=acc.characters.filter(c=>c.id!==charId);
 save();render();
}
function resetAllData(){
 if(!confirm("âš  Hapus SEMUA data tracker?\nAccount, character, progress akan hilang!")) return;
 localStorage.removeItem(STORE);
 location.reload();
}
/* ================= RESET SETTINGS UI ================= */

function openResetSettings(){
 const m=document.getElementById("resetModal");
 m.style.display="block";

 const daily=data.tasks.find(t=>t.type==="daily");
 const weekly=data.tasks.find(t=>t.type==="weekly");
 const shop=data.tasks.find(t=>t.type==="shop");

 m.innerHTML=`
  <div class="modal-backdrop" onclick="closeResetSettings(event)">
   <div class="modal" onclick="event.stopPropagation()">
    <h3>âš™ Reset Settings</h3>

    <h4 style="color:var(--accent)">DAILY</h4>
    <div class="form-row">
     <label>Reset Hour</label>
<input type="time" id="dailyHour"
 value="${String(daily.hour).padStart(2,"0")}:${String(daily.minute||0).padStart(2,"0")}">
    </div>

<h4 style="color:var(--weeklyAccent)">WEEKLY</h4>
<div class="form-row">
 <select id="weeklyDay">${dayOptions(weekly.day)}</select>
 <input type="time" id="weeklyHour"
  value="${String(weekly.hour).padStart(2,"0")}:${String(weekly.minute||0).padStart(2,"0")}">
</div>

<h4 style="color:var(--shopAccent)">WEEKLY SHOP</h4>
<div class="form-row">
 <select id="shopDay">${dayOptions(shop.day)}</select>
 <input type="time" id="shopHour"
  value="${String(shop.hour).padStart(2,"0")}:${String(shop.minute||0).padStart(2,"0")}">
</div>
<h4>APPLY MODE</h4>
<div class="form-row">
 <label>
  <input type="radio" name="applyMode" value="next" checked>
  Apply mulai reset berikutnya
 </label>
</div>
<div class="form-row">
 <label style="color:var(--danger)">
  <input type="radio" name="applyMode" value="now">
  Apply & reset semua sekarang
 </label>
</div>
    <div class="modal-footer">
     <button onclick="closeResetSettings()">Cancel</button>
     <button class="primary" onclick="saveResetSettings()">Save</button>
    </div>
   </div>
  </div>
 `;
}

function closeResetSettings(e){
 if(e && e.target!==e.currentTarget) return;
 document.getElementById("resetModal").style.display="none";
}

function dayOptions(selected){
 const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
 return days.map((d,i)=>
  `<option value="${i}" ${i===selected?"selected":""}>${d}</option>`
 ).join("");
}

function saveResetSettings(){
 const dailyHourEl  = document.getElementById("dailyHour");
 const weeklyHourEl = document.getElementById("weeklyHour");
 const shopHourEl   = document.getElementById("shopHour");
 const weeklyDayEl  = document.getElementById("weeklyDay");
 const shopDayEl    = document.getElementById("shopDay");

 const mode = document.querySelector('input[name="applyMode"]:checked')?.value || "next";

 // update task reset config
 data.tasks.forEach(t=>{
  if(t.type==="daily"){
   const [h,m]=dailyHourEl.value.split(":");
   t.hour=+h; t.minute=+m;
  }
  if(t.type==="weekly"){
   const [h,m]=weeklyHourEl.value.split(":");
   t.day=+weeklyDayEl.value;
   t.hour=+h; t.minute=+m;
  }
  if(t.type==="shop"){
   const [h,m]=shopHourEl.value.split(":");
   t.day=+shopDayEl.value;
   t.hour=+h; t.minute=+m;
  }
 });

 // ðŸ§  PRO LOGIC
 data.accounts.forEach(acc=>{
  acc.characters.forEach(c=>{
   data.tasks.forEach(t=>{
    if(!c.progress[t.id]) return;

if(mode === "next"){
 // JANGAN reset checklist
 c.progress[t.id].lastReset = resetWindowId(t);
 c.progress[t.id].resetAt ??= 0;
}

    if(mode==="now"){
     // force reset sekarang
c.progress[t.id]={
 checked:false,
 count: t.max ? 0 : undefined,
 lastReset: resetWindowId(t),
 resetAt: Date.now()
};
    }
   });
  });
 });

 save();
 closeResetSettings();
 render();
}
setInterval(()=>{
 document.querySelectorAll(".countdown").forEach(el=>{
  const type = el.dataset.type;
  el.textContent = sectionCountdown(type);
 });

 autoResetCheck();
},1000);
/* ================= INIT ================= */
if(!data.accounts.length){
 const name = prompt("Masukkan nama Account:");

 data.accounts.push({
  id:"acc"+Date.now(),
name: name && name.trim() ? name.trim() : "Default",
  characters:[]
 });

 data.activeAccountId = data.accounts[0].id;
 save();
}
render();
async function forceUpdatePWA(){
 if(!confirm("Force update aplikasi?")) return;

 if ("serviceWorker" in navigator) {
  const regs = await navigator.serviceWorker.getRegistrations();
  for (const reg of regs) {
   await reg.unregister();
  }
 }

 if ("caches" in window) {
  const keys = await caches.keys();
  await Promise.all(keys.map(k => caches.delete(k)));
 }

 location.reload();
}
function showUpdatePopup(){
 document.getElementById("updatePopup").classList.remove("hidden");
}

function hideUpdate(){
 document.getElementById("updatePopup").classList.add("hidden");
}

async function applyUpdate(){
 const regs = await navigator.serviceWorker.getRegistrations();
 for (const reg of regs) {
  await reg.unregister();
 }
 location.reload();
}
</script>
<script>
let marketCalcInited = false;
if ("serviceWorker" in navigator) {
 navigator.serviceWorker.register("/daily-task/service-worker.js");

 navigator.serviceWorker.addEventListener("controllerchange", () => {
  location.reload();
 });

 navigator.serviceWorker.addEventListener("message", event => {
  if (event.data?.type === "UPDATE_READY") {
   const last = localStorage.getItem("app_version");

   if (last !== event.data.version) {
    showUpdatePopup();
    localStorage.setItem("app_version", event.data.version);
   }
  }
 });
}
function openMarketCalc(){
 document.getElementById("marketCalcModal").style.display="flex";

 if(!marketCalcInited){
  initMarketCalc();
  marketCalcInited = true;
 }
}
function closeMarketCalc(){
 document.getElementById("marketCalcModal").style.display="none";
}
function formatRupiah(num){
 return num.toLocaleString("id-ID");
}

function parseRupiah(str){
 return parseInt(str.replace(/[^\d]/g,"")) || 0;
}
function initMarketCalc(){
 let STEP = 1000;
 const amt = document.getElementById("calcAmount");

 function calc(){
  const raw = parseRupiah(amt.value);

  // auto format input
  if(amt.value){
   amt.value = formatRupiah(raw);
  }

  if(!raw){
   document.querySelector("#calcA b").textContent="-";
   document.querySelector("#calcB b").textContent="-";
   document.getElementById("calcDiff").textContent="-";
   return;
  }

  const mode = document.querySelector('input[name="calcMode"]:checked').value;
  let a,b,d;

  if(mode==="gross"){
   a = Math.floor(raw * 0.9);
   b = Math.floor(raw * 0.8);
   d = a - b;
  }else{
   a = Math.ceil(raw / 0.9);
   b = Math.ceil(raw / 0.8);
   d = b - a;
  }

  document.querySelector("#calcA b").textContent = formatRupiah(a);
  document.querySelector("#calcB b").textContent = formatRupiah(b);
  document.getElementById("calcDiff").textContent = formatRupiah(d);
 }

 amt.oninput = calc;

// keypad angka (PATCH AMAN)
document.querySelectorAll(".calc-keypad button[data-n]").forEach(b=>{
 b.onclick = ()=>{
  const current = parseRupiah(amt.value);   // ambil angka bersih
  const digit   = parseInt(b.dataset.n);    // angka ditekan
  const next    = current * 10 + digit;     // append numeric

  amt.value = formatRupiah(next);
  calc();
 };
});
// tombol hapus 1 digit (BACKSPACE)
document.querySelector(".calc-keypad button[data-back]").onclick = ()=>{
 const current = parseRupiah(amt.value);

 if(!current){
  amt.value = "";
 }else{
  const next = Math.floor(current / 10);
  amt.value = next ? formatRupiah(next) : "";
 }

 calc();
};
 // tombol +
 document.querySelector("[data-step='+']").onclick = ()=>{
  amt.value = formatRupiah(parseRupiah(amt.value) + STEP);
  calc();
 };

 // tombol -
 document.querySelector("[data-step='-']").onclick = ()=>{
  amt.value = formatRupiah(
   Math.max(0, parseRupiah(amt.value) - STEP)
  );
  calc();
 };

 // clear
 document.querySelector(".calc-clear").onclick = ()=>{
  amt.value = "";
  calc();
 };

 // step
 document.getElementById("calcStep").onchange = e=>{
  STEP = parseInt(e.target.value);
 };

 // mode change
 document.querySelectorAll("input[name='calcMode']").forEach(r=>{
  r.onchange = calc;
 });
}

</script>
<div id="resetModal" style="display:none"></div>
<div id="updatePopup" class="update-popup hidden">
 <div class="update-card">
  <h3>Update tersedia ðŸš€</h3>
  <p>Versi terbaru aplikasi sudah siap.</p>
  <div class="update-actions">
   <button onclick="applyUpdate()">Update sekarang</button>
   <button class="ghost" onclick="hideUpdate()">Nanti</button>
  </div>
 </div>
</div>
<div id="marketCalcModal" class="modal-backdrop" style="display:none">
 <div class="modal" onclick="event.stopPropagation()">
  <div style="display:flex;justify-content:space-between;align-items:center">
   <h3>ðŸ“Š Market Calculator</h3>
   <button onclick="closeMarketCalc()" style="border:none;background:none;color:#ff5252;font-size:16px">âœ•</button>
  </div>

  <div class="calc-modes">
   <label><input type="radio" name="calcMode" value="gross" checked>
    Dari harga jual
   </label>
   <label><input type="radio" name="calcMode" value="net">
    Dari target bersih
   </label>
  </div>

  <div class="calc-input">
   <input type="text" id="calcAmount" placeholder="Masukkan nominal">
  </div>

  <div class="calc-result">
   <div id="calcA"><span>Market (10%)</span><b>-</b></div>
   <div id="calcB"><span>World Market (20%)</span><b>-</b></div>
   <div><span>Selisih</span><b id="calcDiff">-</b></div>
  </div>

  <div class="calc-keypad">
   <button data-n="1">1</button><button data-n="2">2</button><button data-n="3">3</button>
   <button data-n="4">4</button><button data-n="5">5</button><button data-n="6">6</button>
   <button data-n="7">7</button><button data-n="8">8</button><button data-n="9">9</button>
   <button data-step="+">+</button><button data-n="0">0</button><button data-step="-">âˆ’</button>
   <button data-back="1">âŒ«</button>
   <button class="calc-clear">C</button>
      <select id="calcStep">
    <option value="1000">1.000</option>
    <option value="10000">10.000</option>
    <option value="100000">100.000</option>
   </select>
  </div>
 </div>
</div>
</body>
</html>
